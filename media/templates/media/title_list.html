{% extends "base.html" %}
{% load media_extras %}
{% block title %}Watchlist{% endblock %}
{% block subtitle %}Мой список{% endblock %}

{% block content %}
  <div class="row" style="margin-bottom: 14px;">
    <div class="muted">Всего: {{ titles|length }}</div>
  </div>

  <details class="filters panel" {% if category %}open{% endif %}>
    <summary>Фильтры по категориям</summary>
    <div class="row" style="margin-top: 12px; justify-content:flex-start;">
      <a class="btn" href="?">Все</a>
      {% for value, label in categories %}
        <a class="btn" href="?category={{ value }}">{{ label }}</a>
      {% endfor %}
    </div>
  </details>

  <div class="grid" style="margin-top: 14px;">
    {% for t in titles %}
      {% with state=t.current_user_states.0 progress=t.current_user_progress.0 %}
      <a class="card" href="{% url 'media:detail' t.pk %}">
        {% if t.poster_url %}
          <img class="poster" src="{{ t.poster_url }}" alt="{{ t.name }}" loading="lazy">
        {% else %}
          <div class="poster"></div>
        {% endif %}

        <div class="card-body">
          <div class="title">{{ t.name }}</div>
          <div class="card-meta">
            <div>
              {% if state %}
                <span class="status-badge status-{{ state.status }}">{{ state.get_status_display }}</span>
              {% endif %}
            </div>

            <div>
              {% if state and state.rating is not None %}
                <span class="rating-stars">{{ state.rating|rating_stars }} {{ state.rating }}/10</span>
              {% endif %}
            </div>

            <div>
              {% if t.is_series and progress and progress.current_season_number and progress.current_episode_number %}
                <span class="muted">Сезон {{ progress.current_season_number }}, Серия {{ progress.current_episode_number }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      </a>
      {% endwith %}
    {% empty %}
      <div class="panel">Пока нет произведений. Перейди в “Импорт” и добавь по KP ID.</div>
    {% endfor %}
  </div>
{% endblock %}
