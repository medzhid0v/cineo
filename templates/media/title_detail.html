{% extends "base.html" %}
{% load media_extras %}
{% block title %}{{ title.name }}{% endblock %}
{% block subtitle %}Карточка произведения{% endblock %}

{% block content %}
  <div class="three-col">
    <div class="card">
      {% if title.poster_url %}
        <img class="poster" src="{{ title.poster_url }}" alt="{{ title.name }}">
      {% else %}
        <div class="poster"></div>
      {% endif %}
    </div>

    <div class="panel">
      <h1 style="margin:0 0 10px;">{{ title.name }}</h1>
      <div class="meta" style="margin-bottom: 12px;">
        <span class="pill">{{ title.get_category_display }}</span>
        {% if title.year %}<span class="pill">{{ title.year }}</span>{% endif %}
        {% if title.duration_min %}<span class="pill">{{ title.duration_min }} мин</span>{% endif %}
      </div>

      <div class="kv">
        <div class="kv-row"><span>КиноПоиск</span><a class="btn" href="{{ title.kp_url }}" target="_blank">Открыть</a></div>
        {% if title.is_series %}
          <div class="kv-row progress-row"><span>Прогресс</span><b class="progress-count">{{ watched_episodes }}/{{ total_episodes }} эпизодов</b></div>
          <div class="kv-row"><span>Текущий</span><b>{% if progress.current_season_number %}S{{ progress.current_season_number|stringformat:'02d' }}E{{ progress.current_episode_number|stringformat:'02d' }}{% else %}—{% endif %}</b></div>
        {% endif %}
      </div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 10px;">Моё</h3>
      <form method="post" action="{% url 'media:update_state' title.pk %}" class="stack">
        {% csrf_token %}
        {{ state_form.status.label_tag }}{{ state_form.status }}
        {{ state_form.rating.label_tag }}{{ state_form.rating }}
        {{ state_form.review.label_tag }}{{ state_form.review }}
        <button class="btn" type="submit">Сохранить</button>
      </form>

      <form method="post" action="{% url 'media:remove' title.pk %}" class="remove-form" style="margin-top:12px;">
        {% csrf_token %}
        <button class="btn btn-danger" type="submit">Удалить из моего списка</button>
      </form>
    </div>
  </div>

  {% if title.is_series %}
    <div class="panel" style="margin-top: 16px;">
      <h3 style="margin:0 0 12px;">Сезоны и эпизоды</h3>
      {% for season in title.seasons.all %}
        <h4>Сезон {{ season.number }}</h4>
        <div class="stack" style="margin-bottom: 14px;">
          {% for episode in season.episodes.all %}
            <div class="kv-row episode-row" data-episode-id="{{ episode.pk }}">
              <span>E{{ episode.number }} {{ episode.name|default:'Без названия' }}</span>
              <form method="post" action="{% url 'media:toggle_episode' title.pk episode.pk %}" class="episode-toggle-form">
                {% csrf_token %}
                <input type="hidden" name="watched" value="{% if episode.pk in watched_episode_ids %}0{% else %}1{% endif %}">
                <button class="btn episode-btn" type="submit" data-watched="{% if episode.pk in watched_episode_ids %}1{% else %}0{% endif %}">{% if episode.pk in watched_episode_ids %}✓ Просмотрено{% else %}Отметить{% endif %}</button>
              </form>
            </div>
          {% empty %}
            <div class="muted">Нет серий в сезоне.</div>
          {% endfor %}
        </div>
      {% empty %}
        <div class="muted">Нет данных по сезонам.</div>
      {% endfor %}
    </div>
  {% endif %}

  <script>
    // AJAX для переключения эпизодов
    document.querySelectorAll('.episode-toggle-form').forEach(form => {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = form.querySelector('.episode-btn');
        const watched = btn.dataset.watched === '1';
        const formData = new FormData(form);
        formData.set('watched', watched ? '0' : '1');
        
        try {
          const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            btn.dataset.watched = data.watched ? '1' : '0';
            btn.textContent = data.watched ? '✓ Просмотрено' : 'Отметить';
            form.querySelector('input[name="watched"]').value = data.watched ? '0' : '1';
            
            // Обновляем счетчики если они есть
            if (data.watched_episodes !== undefined && data.total_episodes !== undefined) {
              const progressCount = document.querySelector('.progress-count');
              if (progressCount) {
                progressCount.textContent = `${data.watched_episodes}/${data.total_episodes} эпизодов`;
              }
            }
          }
        } catch (error) {
          console.error('Ошибка при обновлении эпизода:', error);
        }
      });
    });

    // AJAX для удаления
    document.querySelector('.remove-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!confirm('Удалить из списка?')) return;
      
      const formData = new FormData(e.target);
      try {
        const response = await fetch(e.target.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        
        if (response.ok) {
          window.location.href = '{% url "media:list" %}';
        }
      } catch (error) {
        console.error('Ошибка при удалении:', error);
      }
    });
  </script>
{% endblock %}
